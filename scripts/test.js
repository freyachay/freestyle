ejdict = {"prob'ly":['P R AA1', 'B L IY0'],
          "practic'ly": ['P R AE1 K','T AH0 K','L IY0'],
          "acquiescent":  ["AE2","K W IY0","EH1","S AH0 N T"],
          "mediocrities": ["M IY2","D IY0","AA1","K R AH0","T IY0 Z"],
          "casse": ["K AH0 S"],
          "bonsoir": ["B AA0 N","S W AA1"],
          "m'appelle": ["M AH0","P EH1 L"],
          "toi": ["T W AA1"],
          "brrrah": ["B R AA1"],
          "brraaah": ["B R AA1"],
          "drano": ['D R EY1','N OW0'],
          "am":["AE1 M"],
          "diametric'ly": ["D AY2","AH0","M EH1","T R IH0 K","L IY0"],
          "hypertone": ["HH AY1","P ER0","T OW2 N"],
          "unawareness": ["AH2 N","AH0","W EH1 R","N AH0 S"],
          "assassinator": ["AH0","S AE1","S AH0","N EY2 T","AO0 R"],
          "fiending": ["F IY1 N","D IH0 NG"],
          "dj": ["D IY1","JH EY0"],
          "ev'ry": ['EH1', 'V R IY0'],
          "famished": ['F AE M', 'IH SH T'],
          "blamin'": ["B L EY1", "M IH0 N"],
          "corsets": ["K AO1 R","S AH0 T S"],
          "shittin'": ["SH IH1", "T IH0 NG"],
          "hist'ry": ["HH IH1","T R IY0"],
          "onarchy": ["AA1","N AA0 R","K IY0"],
          "knuckleheads": ["N AH1", "K AH0 L", "HH EH2 D Z"],
          "parentis": ["P AH0","R EH1 N","T AH0 S"],
          "cuz": ["K AH1 Z"],
          "manumission": ["M AE1","N Y UW0","M IH2","SH AH0 N"],
          "hungriest": ["HH AH1 NG", "G R IY0","AH0 S T"],
          "unimpeachable": ["AH2 N","IH0 M","P IY1","CH AH0","B OW0 L"],
          "impoverished": ["IH0 M","P AA1","V ER0","IH0 SH T"],
          "i'mma": ["AY1","M AH0"],
          "rakim": ["R AH0","K IY1 M"],
          "microphonist": ["M AY1","K R AH0","F OW2","N AH0 S T"],
          "dissed": ["D IH1 S T"],
          "7": ["S EH1","V AH0 N"],
          "21": ["T W EH1 N","T IY0","W AH1 N"],
          "fessing": ["F EH1","S IH0 NG"],
          "dissing": ["D IH1","S IH0 NG"],
          "marl": ["M AA1 R L"],
          "blaow": ["B L AW1"],
          "illest": ["IH1 L", "AH0 S T"],
          "realest": ["R IY1 L", "AH0 S T"],
          "50": ["F IH1 F", "T IY0"],
          "underoo": ["AH1 N","D ER0","UW2 S"],
          "'what's": ["W AH0 T S"],
          "hoodie": ["HH UH1","D IY0"],
          "atch": ["AE1 CH"],
          "niggas'll": ["N IH1","G AH0 Z","UH0 L"],
          "nigga": ["N IH1","G AH0"],
          "niggaz": ["N IH1","G AH0 Z"],
          "dunny": ["D AH1","N IY0"],
          "fucker": ["F AH1", "K ER0"],
          "fistfight": ["F IH1 S T","F AY2 T"],
          "motherfucking": ["M AH2","DH ER0","F AH1","K IH0 NG"],
          "motherfucker": ["M AH2","DH ER0","F AH1","K EH0"],
          "wonka": ["W AE1 N", "K AH0"],
          "us": ["AH1 S"],
          "thirstay": ["TH ER1","S T EY0"],
          "las": ["L AA1 S"],
          "ovaltine": ["OW1","V AH0 L","T IY2 N"],
          "'cedes": ["S EY1","D IY0 Z"],
          "papi": ["P AA1","P IY0"],
          "mobb": ["M AA1 B"],
          "guccis": ["G UW1","CH IY0 Z"],
          "poom": ["P UW1 M"],
          "pooms": ["P UW1 M Z"],
          "boones": ["B UW1 N Z"],
          "hoochies": ["HH UW1","CH IY0"],
          "coochies": ["K UW1","CH IY0"],
          "fugees": ["F UW1","ZH IY0 Z"],
          "sess": ["S EH1 S"],
          "goretex": ["G AO1 R","T EH0 K S"],
          "'n'": ["EH0 N"],
          "gon'": ["G AA1 N"],
          "perfected": ["P ER0","F EH1 K","T IH0 D"],
          "def": ["D EH1 F"],
          "hero": ["H IY1","R OW0"],
          "mo'": ["M OW1"],
          "nas": ["N AA1 S"],
          "bama": ["B AE1","M AH0"],
          "audemars": ["AO1","D EH0","M AA0 R S"],
          "rollies": ["R OW1","L IY0 Z"],
          "illuminati": ["IH0","L UW1","M IH0","N AA0","T IY0"],
          "kanye": ["K AA1 N","Y EY0"],
          "cadien": ["K EY1","D IY0","AH0 N"],
          "rhyme": ["R AY1 M"],
          "rhymers": ["R AY1 M","ER0 Z"],
          "flossing": ["F L AO1 S","IH0 NG"],
          "tulip": ["T UW1","L IH0 P"],
          "illing": ["IH1 L","IH0 NG"],
          "'88": ["EY1","T IY0","EY2 T"],
          "demeanour": ["D IH0","M IY1","N ER0"],
          "jigga": ["JH IH1","G AH0"],
          "hova": ["HH OW1","V AH0"],
          "hov": ["HH OW1 V"],
          "masqueradin": ["M AE2 S","K ER0","EY1","D IH0 N"],
          "atomically": ["AH0","T AA1","M AH0 K","L IY0"],
          "mockerie": ["M AA1","K ER0","IY0"],
          "killa": ["K IH1","L AH1"],
          "beez": ["B IY1 Z"],
          "shackling": ["SH AE1","K AH0", "L IH0 NG"],
          "shinobi": ["SH IH0","N OW1", "B IY0"],
          "y'all'll": ["Y AO2 L","UH0 L"],
          "baddest": ["B AE1","D EH0 S T"],
          "effervescence": ["EH2","F ER0","V EH1","S EH0 N S"],
          "16": ["S IH0 K S","T IY1 N"],
          "steelo": ["S T IY1", "L OW0"],
          "ceelo": ["S IY1", "L OW0"],
          "airplay": ["EH1 R","P L EY0 N"],
          "baseheads": ["B EY1 S","HH EH2 D Z"],
          "amps": ["AE1 M P S"],
          "yellowback": ["Y EH1","L OW0","B AE2 K S"],
          "realness": ["R IY1 L","N AH0 S"],
          "queensbridge": ["K W IY1 N Z","B R IH2 JH"],
          "nuff": ["N AH1 F"],
          "squadron'll": ["S K W AA1","D R AH0 N","UH0 L"],
          "bp": ["B IY1","P IY2"],
          "maÃ±ana": ["M AH0 N","Y AA1","N AA0"],
          "manzana": ["M AH0 N","Z AA1","N AA0"],
          "pana": ["P AA1","N AA0"],
          "slurping": ["S L ER1","P IH0 NG"],
          "diddly": ["D IH1 D","L IY0"],
          "loca": ["L OW1","K AH0"],
          "tocha": ["T OW1","CH AH0"],
          "pinga": ["P IH1 NG", "G AH0"],
          "bolla": ["B OW1","L AH0"],
          "boriqua": ["B AO0 R","IY1","K W AH0"],
          "'scuse": ["S K Y UW1 S"],
          "cunt": ["K AH1 N T"],
          "menage": ["M AY1","N AA2 JH"],
          "percenter": ["P ER0","S EH1 N","T ER0"],
          "capers'll": ["K EY1","P ER0 Z","UH0 L"],
          "bullethole": ["B UH1","L AH0 T","HH OW2 L"],
          "peephole": ["P IY1 P","HH OW2 L"],
          "boardhead": ["B AO1 R D","HH EH2 D"],
          "1000": ["W AH1 N","TH AW2","Z AH0 N D"],
          "lb": ["EH1 L","B IY2"],
          "punisher": ["P AH1","N IH0","SH ER0"],
          "slaver": ["S L EY1","V ER0"],
          "ev'ryone": ["EH1","V R IY0","W AH2 N"],
          "rochambeau": ["R OW1","SH AE0 M","B OW2"],
          "ingenuitive": ["IH0 N","JH AH0","N UW1","AH0","T IH0 V"],
          "outplanned": ["AW0 T","P L AE1 N D"],
          "giddyup": ["G IH1","D IY0","AH2 P"]
         }


// *********** CLASSES ***********
// ## Syl
// Syls are the main elements used to structure our rhyme comparison.
// Syls map to syllables and are compared to other syllables to establish rhyme.
function Syl(sounds,index,pro_index){
    this.sounds = sounds;
    this.raw_sounds = _.map(sounds,function(s){
        return destress(s);
    });
    
    // We break the syllable into a vowel, a prefix, and a suffix.
    this.vowel = _.find(sounds,function(s){
        return _.contains(vowel_sounds,destress(s));
    });

    this.vowel_index = sounds.indexOf(this.vowel);
    this.suffix = sounds.slice(this.vowel_index + 1);
    this.prefix = this.sounds.slice(0,this.vowel_index);

    // Syllable index and pronunciation index are use for contextual comparisons with
    // other syllables based on position
    this.index = index;
    this.pro_index = pro_index;

    // Total mark will record how strongly the syllable rhymes with all other syllables
    // in the verse
    this.total_mark = 0;

    // Color is used to group syllables into rhyme families
    this.color = 0;

    // Stress is used to score the quality of rhymes. Two stressed syllables rhyme more
    // strongly than one stressed and one unstressed. One stressed and one unstressed 
    // syllable rhyme more strongly than two unstressed syllables.
    if(! this.vowel){
        this.stressed = false;
    } else {
        this.stressed = this.vowel.indexOf("1") > 0 || this.vowel.indexOf("2") > 0;
    }

    // Head and tail neighbors are used to form rhyme patterns and strengthen or weaken
    // rhyme scores based on nearness to other rhyming syllables
    this.head_neighbors = [];
    this.tail_neighbors = [];

    // End word determines if the syllable is part of the last word on a line.
    // This is used to identify end rhymes.
    this.end_word = false;

}

// The label function is used to generate unique ids for each syllable, which 
// will be used for node names in the eventual syllable graph
Syl.prototype.label = function(){
    return this.parent.index + "-" + this.index + "-" + this.pro_index;
};

// The sameAs function is used to evaluate similar syllables across pronunciations
Syl.prototype.sameAs = function(s){
    return this.index == s.index &&
           this.parent.index == s.parent.index;
};

// ## Phoword
// Syllables are collected into pronuncation arrays, collected into Phowords. This 
// allows us to eventually map the syllables back onto the original words.
function Phoword(word,pros,index){
    this.word = word;
    this.pros = pros;
    this.index = index;
    this.sentence = -1;
    this.final_syls = [];

    var w = this;

    // For the last Phoword of each line, mark each of their syllables as belonging
    // to an end word.
    _.each(pros,function(p){
        var last_syl = p.length - 1;
        _.each(p,function(syl,i){
            syl.parent = w;
            if(i == last_syl){
                syl.end_syl = true;
            } else {
                syl.end_syl = false;
            }
        });
    });
}
// ********************************


// ********* FUNCTIONS ************
// **cleanSentence**
//
// Remove all smart apostrophes and single quotes
function cleanSentence(sentence){
    return _.map(sentence,function(word){
        return word.replace(/â€™|â€˜/g,"'");
    });
}

// **replacePros**
//
// Used to manually adjust certain pronuncations 
function replacePros(word,new_sounds,last_syl){
    _.each(word.pros,function(p,pi){
        var newsyl = new Syl(new_sounds,last_syl.index,pi);
        newsyl.parent = last_syl.parent;
        p.pop();
        p.push(newsyl);
    });
    return word;
}

// **lookup**
//
// Used to translate a raw english word into a series of syllablized, arpabet
// pronunciations
function lookup(w,sentence,index){
    var pros, sylpros, final_word, new_word, word, last_syl, new_sounds, newpro;

    // You can't look the word 'constructor' up in javascript. It is a reserved word.
    if (w === "constructor"){
        pros = [["K AH0 N","S T R AH1 K","T ER0"]];
    // First, check our hand-written dictionary
    } else if(ejdict[w]){
        pros = [ejdict[w]];
    // If the word matches a multiple pronunciation entry, grab both pronuncations
    } else if (syldict[w+"(2)"]){
        pros = [syldict[w],syldict[w+"(2)"]];
    // If the word matches a single pronunciation entry, grab it
    } else if (syldict[w]){
        pros = [syldict[w]];
    // If the word ends in 'ah', try the word as an 'er' word. This is used to 
    // handle alternative pronunciation of words common in rap lyrics
    } else if (w.match(/\w+?ah$/i)){
        new_word =  w.match(/(\w+?)ah/)[1] + "er";
        word = lookup(new_word,sentence,index);

        if(word && word.pros[0]){
            last_syl = word.pros[0].slice(-1)[0];
            new_sounds = last_syl.sounds.slice(0,last_syl.vowel_index);
            new_sounds = new_sounds.concat(["AH0"]);

            replacePros(word,new_sounds,last_syl);
        }
        word.word = w;
        return word;
    // If the word ends in n', try the word as an "ng" word
    } else if (w.match(/\w+?n[\'|â€™]?$/)){
        new_word =  w.match(/\w+/)[0] + "g";
        word = lookup(new_word,sentence,index);

        if(word && word.pros[0]){
            last_syl = word.pros[0].slice(-1)[0];
            new_sounds = last_syl.sounds;
            new_sounds = new_sounds.slice(0,-1).concat(["N"]);

            replacePros(word,new_sounds,last_syl);
        }
        word.word = w;
        return word;
    // If the word ends in s', try the word without the final apostrophe
    } else if (w.match(/\w+?s[\'|â€™]$/)){
        new_word = w.match(/\w+/)[0];
        word = lookup(new_word,sentence,index);

        if(word && word.pros[0]){
            last_syl = word.pros[0].slice(-1)[0];
            new_sounds = last_syl.sounds;

            replacePros(word,new_sounds,last_syl);
        }
        word.word = w;
        return word;
    // If the word is an 's possessive, try to lookup the word without the s and then add
    // the sound back on
    } else if (w.match(/\w+\'s/)){
        new_word = w.match(/\w+/)[0];
        word = lookup(new_word,sentence,index);

        if(word && word.pros[0]){
            last_syl = word.pros[0].slice(-1)[0];
            new_sounds = last_syl.sounds;
            new_sounds = new_sounds.concat(["S"]);

            replacePros(word,new_sounds,last_syl);
        }
        word.word = w;
        return word;
    // If the word is a plural, try the word without the s and then add the sound
    // back on 
    } else if (w.match(/'\w+?s/)){
        new_word = w.replace(/s$/,"");
        word = lookup(new_word,sentence,index);

        if(word && word.pros[0]){
            last_syl = word.pros[0].slice(-1);
            new_sounds = last_syl.sounds;
            new_sounds = new_sounds.slice(0,-1).concat(["S"]);

            replacePros(word,new_sounds,last_syl);
        }
        word.word = w;
        return word;
    // Otherwise, we cannot lookup the word
    } else {
        pros = [];
        console.log("Could not lookup",w);
    }

    // Often "-shan" words such as "Egyptian" are pronounced as "-shin" words,
    // so add that pronunciation
    var er_fudge = false;
    if (pros.length === 1 && pros[0].slice(-1) && pros[0].slice(-1)[0] === "SH AH0 N"){
        newpro = _.clone(pros[0]);
        last_syl = newpro.pop();
        last_syl = "SH IH0 N";
        newpro.push(last_syl);
        pros.push(newpro);
    }

    // Often "-er" words such as "monster are pronounced as "-ah" words ("monstah"),
    // so add that pronunciation
    if (pros.length > 0 && pros[0].slice(-1) && pros[0].slice(-1)[0].match(/ER\d$/)){
        newpro = _.clone(pros[0]);
        last_syl = newpro.pop();
        last_syl = last_syl.replace(/(.*?)ER(\d)$/,"$1AH$2");
        newpro.push(last_syl);
        pros.push(newpro);
        er_fudge = true;
    }

    // Often "-ers" words such as "monster are pronounced as "-ahs" words ("monstahs"),
    // so add that pronunciation
    if (pros.length > 0 && pros[0].slice(-1) && pros[0].slice(-1)[0].match(/ER\d Z$/)){
        newpro = _.clone(pros[0]);
        last_syl = newpro.pop();
        last_syl = last_syl.replace(/(.*?)ER(\d) Z$/,"$1AH$2 Z");
        newpro.push(last_syl);
        pros.push(newpro);
        er_fudge = true;
    }

    // Map every pronunciation on to an array of Syls
    sylpros = _.map(pros, function(p,pi){
        return _.map(p, function(syl,syli){
            if(!syl){
                console.log(w);
            }
            return new Syl(syl.split(" "),syli,pi);
        });
    });

    // If we added an "-er" to "-ah" pronunciation, mark the syllable. We will
    // use this information to make rhymes against this pronunciation stricter
    if(er_fudge){
        if(sylpros.slice(-1)[0] && sylpros.slice(-1)[0].slice(-1)[0]){
            sylpros.slice(-1)[0].slice(-1)[0].er_fudge = true;
        }
    }

    final_word = new Phoword(w,sylpros,index);
    final_word.sentence = sentence;
    return final_word;
}

// **processText**
//
// Transform an array of string arrays (a series of sentences) into
// an array of Phoword arrays
function processText(text){
    var lines, filtered, numbered, index, sounds, all_words, all_syls;

    // Tokenize each line into words, separating out all non-apostrophe punctuation
    lines = _.map(text,function(line){
        return line.match(/[\w\'â€™]+|[^\w\s\'â€™]+/g);
    });

    // Remove all smart single-quotes
    lines = _.map(lines,function(s){
        return cleanSentence(s);
    });

    // Remove all non-apostrophe punctuation and other non-word noise
    filtered = _.map(lines,function(sentence){
        var words = _.filter(sentence,function(w){
            return w.match(/[\w\']{2,}|\w+/);
        });
        return _.map(words,function(w){return w.toLowerCase();});
    });

    numbered = [];
    index = 0;

    // Number each sentence and word
    _.each(filtered,function(sentence){
        var s = [];
        _.each(sentence,function(word){
            s.push([word,index]);
            index++;
        });
        numbered.push(s);
    });

    // Lookup each word and transform it into a Phoword
    sounds = _.map(numbered, function(sentence,sentence_index){
        return _.map(sentence, function(s){
            var w = s[0],
                w_index = s[1];
            return lookup(w,sentence_index,w_index);
        });
    });

    // Flatten the sentences into an array of words
    all_words = _.flatten(sounds,true);

    // Filter out any falsy values (nulls, undefineds, etc)
    all_words = _.filter(all_words,function(w){return w;});

    all_syls = [];

    // Create a flat list of syllables
    _.each(all_words,function(word){
        _.each(word.pros,function(p){
            _.each(p,function(syl){
                all_syls.push(p);
            });
        });
    });

    return [sounds,all_syls,all_words];
}

function init(syllines){
    var syldict = {};

    _.each(syllines,function(line){
        var pieces = line.split(" "),
            word = pieces[0].toLowerCase(),
            sylls = _.map(pieces.slice(1).join(" ").split("-"),function(s){
                return s.trim();
            });
         syldict[word] = sylls;
    });
    window.syldict = syldict;
}
// *******************************



// ********* MAIN AREA ***********

var xhr = new XMLHttpRequest();
xhr.open('GET', encodeURI('cmudict.js'));
xhr.onload = function() {
    if (xhr.status === 200) {
        var syllines = xhr.responseText.split("\n");
        init(syllines);
        i = 0;
    }
    else {
        console.log('Request failed.  Returned status of ' + xhr.status);
    }
};
xhr.send();

var lyrics = document.getElementById("lyrics").innerHTML.split("\n"),
    process = processText(lyrics.concat(["xxx"])),
    sounds = process[0],
    syllables = _.flatten(process[1]),
    words = process[2];

console.log("Made it through")


// *******************************

// // Determine if any words couldn't be looked up
// var missing_words = _.some(words,function(w){
//     return w.pros.length === 0 && w.word != "xxx";
// });

// // Adjust for a strictness parameter
// mcl_param = document.getElementById("fader").value;
// window.SCALE = (mcl_param - 2)/3.5;

// // Put each syllable into a dictionary based on its label for easy
// // debugging and crossreference
// syl_dict = {};
// _.each(syllables,function(s,i){
//     syl_dict[s.label()] = s;
// });

// // Assign each syllables its neighbors
// findNeighbors(words);

// // Assign each syllables its scored rhymes
// var G = findMatches(words);

// // Pick which pronunciations to use
// var winners = pickWinners(sounds),
//     reduced_syls = winners[0],
//     flat_syls = winners[1];

// // Run our first clustering into rhyme families
// var first_mcl = createMCL(flat_syls,G,2 + SCALE);
// var partition = makeClusters(syl_dict,G,first_mcl);
// clusterColor(partition);
// var groups = cleanFinalColors(flat_syls,G,syl_dict);

// var final_mcl,final_partition,final_groups;